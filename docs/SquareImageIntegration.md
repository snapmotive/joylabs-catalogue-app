# Square Image Integration Documentation

## Overview
This document explains how Square's Catalog API Image System works and how our app integrates with it. **READ THIS BEFORE TOUCHING IMAGE CODE.**

## The Critical Bug That Cost Hours
**THE BUG**: CrossReferenceService was reading `itemData.image_ids` instead of `itemData.item_data.image_ids`
**THE RESULT**: Items always showed `images: []` even though images existed and were properly linked
**THE FIX**: Changed line 150 in CrossReferenceService to use correct JSON path

## Square's Catalog API Image System

### 1. Image Storage Structure
- Images are stored as separate `CatalogImage` objects
- Each `CatalogImage` contains a URL field generated by Square after upload
- `CatalogImage` objects can be associated with `CatalogItem`, `CatalogItemVariation`, `CatalogCategory`, and `CatalogModifierList`

### 2. Square's Two-Step Image Retrieval Process
**Step 1: Get Item Data**
- Use `LIST /v2/catalog/list` or `GET /v2/catalog/object/{object_id}` to retrieve catalog items
- The catalog item response includes an array of image IDs in `item_data.image_ids`

**Step 2: Get Image URLs**
- The list catalog API doesn't include actual image URLs
- Use the image IDs to make separate calls: `GET /v2/catalog/object/{image_id}`
- The `CatalogImage` object contains the actual URL field

### 3. Square API Data Structure
```json
{
  "type": "ITEM",
  "id": "ITEM_ID_HERE",
  "item_data": {
    "name": "Item Name",
    "image_ids": ["IMAGE_ID_1", "IMAGE_ID_2"],
    // ... other item data
  }
}
```

```json
{
  "type": "IMAGE", 
  "id": "IMAGE_ID_HERE",
  "image_data": {
    "name": "image_name.jpg",
    "url": "https://items-images-production.s3.us-west-2.amazonaws.com/files/...",
    "caption": "Image caption"
  }
}
```

## Our App's Image Pipeline

### 1. Sync Process (catalogSync.ts)
- **Full sync** downloads all catalog objects from Square
- **ITEM objects** stored with `image_ids` in `item_data.image_ids`
- **IMAGE objects** stored with URLs in `image_data.url`
- **Database storage**: Full Square object stored in `data_json` field

### 2. Database Schema
```sql
-- Items table stores full Square object
CREATE TABLE catalog_items (
  id TEXT PRIMARY KEY,
  data_json TEXT, -- Contains full Square CatalogItem object
  -- ... other fields
);

-- Images table stores image data
CREATE TABLE images (
  id TEXT PRIMARY KEY,
  url TEXT,        -- Square-provided image URL
  name TEXT,
  caption TEXT,
  data_json TEXT,  -- Contains full Square CatalogImage object
  -- ... other fields
);
```

### 3. Item Retrieval (CrossReferenceService.ts)
**CRITICAL**: Must read from correct JSON path
```javascript
// CORRECT ✅
const itemData = JSON.parse(itemRow.item_data_json || '{}');
const imageIds = itemData.item_data?.image_ids || [];

// WRONG ❌ - This was the bug!
const imageIds = itemData.image_ids || [];
```

### 4. Image Loading Process
1. **Get item** from database
2. **Parse `data_json`** to extract `item_data.image_ids`
3. **Query images table** using image IDs
4. **Return images** with URLs for display

## Key Integration Points

### 1. Image Creation (squareImageService.ts)
- Upload image to Square with `object_id: itemId`
- Square automatically adds image ID to item's `image_ids` array
- **No manual linking needed** - Square handles this

### 2. Image Display (CrossReferenceService.ts)
- **ALWAYS** read from `itemData.item_data.image_ids`
- **NEVER** read from `itemData.image_ids` (root level)
- Query images table using the extracted image IDs

### 3. Image Caching (ImageService.ts)
- Cache images by ID for performance
- Invalidate cache on catalog updates
- Handle missing images gracefully

## Common Pitfalls & Solutions

### ❌ Wrong JSON Path
```javascript
// WRONG - Will always return empty array
const imageIds = itemData.image_ids || [];
```

### ✅ Correct JSON Path  
```javascript
// CORRECT - Reads from Square's actual structure
const imageIds = itemData.item_data?.image_ids || [];
```

### ❌ Manual Image Linking
- Don't try to manually link images to items
- Square handles this automatically via `object_id`

### ✅ Trust Square's System
- Use Square's `image_ids` arrays in items
- Follow the two-step retrieval process
- Let Square manage the relationships

## Testing Checklist

### After Any Image-Related Changes:
1. **Full sync** - Verify images are downloaded
2. **Check item with known images** - Should show `image_ids` in logs
3. **View item in app** - Images should display
4. **Check CrossReferenceService logs** - Should show image loading
5. **Verify image URLs** - Should be valid Square S3 URLs

### Debug Commands:
```javascript
// Check if item has image_ids
console.log('Item data:', JSON.parse(itemRow.item_data_json));
console.log('Image IDs:', itemData.item_data?.image_ids);

// Check if images exist in database
SELECT * FROM images WHERE id IN ('IMAGE_ID_1', 'IMAGE_ID_2');
```

## Never Do This Again

### The Exact Error That Caused Hours of Debugging:
- **File**: `src/services/crossReferenceService.ts`
- **Line**: 150 (approximately)
- **Error**: Reading `itemData.image_ids` instead of `itemData.item_data.image_ids`
- **Impact**: Items always showed empty images array
- **Time Lost**: Multiple hours of debugging

### Prevention:
1. **Always check Square's API documentation** for correct data structure
2. **Test with known items that have images** after any changes
3. **Log the actual data structure** when debugging
4. **Follow this document** instead of guessing

## Final Notes

- **Square's image system works perfectly** - don't fight it
- **Our integration is simple** - just follow Square's structure
- **The bug was a simple JSON path error** - not a complex system issue
- **Always read from `item_data.image_ids`** - this is Square's standard

**If images aren't showing, check the JSON path first. It's probably this same stupid error.**
